 SELECT
                CASE WHEN KH.CODIGOGA = 31 THEN 'PARANOÁ' WHEN KH.CODIGOGA = 124 THEN 'SANTA MARIA' WHEN KH.CODIGOGA = 239 THEN 'SÃO SEBASTIÃO' WHEN KH.CODIGOGA = 240 THEN 'GAMA' ELSE 'OUTRAS' END AS SETOR,
                TRUNC(KH.DATA_BASE, 'mm') AS DATA_MES_ANO,
                -- Soma dos componentes diários para obter o total mensal
                NVL(SUM(KO.KM_OPER), 0) AS KM_OPER,
                NVL(SUM(KH.KM_HOD - NVL(KE.KM_ESP, 0) - NVL(KI.KMTOTALINT, 0)), 0) AS KM_HOD2
            FROM
                ( SELECT V.CODIGOGA, TRUNC(C.DATAVELOC) AS DATA_BASE, SUM(C.KMPERCORRIDOVELOC) AS KM_HOD FROM VWABA_CONFKMCARRO C JOIN FRT_CADVEICULOS V ON V.CODIGOVEIC = C.CODIGOVEIC WHERE C.DATAVELOC >= TO_DATE(:1, 'YYYY-MM-DD') AND C.DATAVELOC < TO_DATE(:2, 'YYYY-MM-DD') + 1 AND TO_TIMESTAMP(TO_CHAR(C.DATAVELOC, 'YYYY-MM-DD') || ' ' || C.HORAVELOC, 'YYYY-MM-DD HH24:MI') >= TO_TIMESTAMP(TO_CHAR(C.DATAVELOC, 'YYYY-MM-DD') || ' 04:00', 'YYYY-MM-DD HH24:MI') AND V.CODIGOEMPRESA = 4 AND V.CONDICAOVEIC = 'A' AND V.CODIGOGA IN (31, 124, 239, 240) GROUP BY V.CODIGOGA, TRUNC(C.DATAVELOC) ) KH
                LEFT JOIN ( SELECT V.CODIGOGA, TRUNC(A.DATABCO) AS DATA_BASE, SUM(NVL(GLOBUS.FC_ARR_KMBCO(A.IDBCO, 0), 0)) AS KM_OPER FROM T_ARR_BCO A JOIN T_ARR_BCO_VIAGENS B ON A.IDBCO = B.IDBCO JOIN FRT_CADVEICULOS V ON B.CODIGOVEIC = V.CODIGOVEIC WHERE A.DATABCO BETWEEN TO_DATE(:1, 'YYYY-MM-DD') AND TO_DATE(:2, 'YYYY-MM-DD') + 0.99999 AND B.IDBCOVIAGENS = 1 AND A.CODIGOEMPRESA = 4 AND V.CODIGOEMPRESA = 4 AND V.CODIGOGA IN (31, 124, 239, 240) AND V.CONDICAOVEIC = 'A' GROUP BY V.CODIGOGA, TRUNC(A.DATABCO) ) KO ON KH.CODIGOGA = KO.CODIGOGA AND KH.DATA_BASE = KO.DATA_BASE
                LEFT JOIN ( SELECT V.CODIGOGA, TRUNC(M.DTSAIDA) AS DATA_BASE, SUM(M.ODOMETROFIN - M.ODOMETROINIC) AS KM_ESP FROM PLT_SAIDARECOLHIDA M JOIN FRT_CADVEICULOS V ON M.CODIGOVEIC = V.CODIGOVEIC WHERE M.DTSAIDA >= TO_DATE(:1, 'YYYY-MM-DD') AND M.DTSAIDA < TO_DATE(:2, 'YYYY-MM-DD') + 1 AND M.CODOCORRPLTSAIDA BETWEEN 17 AND 26 AND V.CODIGOEMPRESA = 4 AND V.CONDICAOVEIC = 'A' AND V.CODIGOGA IN (31, 124, 239, 240) GROUP BY V.CODIGOGA, TRUNC(M.DTSAIDA) ) KE ON KH.CODIGOGA = KE.CODIGOGA AND KH.DATA_BASE = KE.DATA_BASE
                LEFT JOIN ( SELECT A.CODIGOGA, SUM(A.QTDVEICFRT * A.KM_INT) AS KMTOTALINT FROM (SELECT V.CODIGOGA, COUNT(V.PREFIXOVEIC) AS QTDVEICFRT, CASE WHEN V.CODIGOGA IN (31, 239) THEN 0.60 WHEN V.CODIGOTPFROTA IN (11, 9) AND V.CODIGOGA = 240 THEN 0.21 WHEN V.CODIGOTPFROTA IN (3, 12) AND V.CODIGOGA = 240 THEN 0.60 WHEN V.CODIGOTPFROTA = 9 AND V.CODIGOGA = 124 THEN 0.60 WHEN V.CODIGOTPFROTA NOT IN (9) AND V.CODIGOGA = 124 THEN 0.80 ELSE 0 END AS KM_INT FROM FRT_CADVEICULOS V WHERE V.CODIGOEMPRESA = 4 AND V.CONDICAOVEIC = 'A' AND V.CODIGOGA IN (31, 124, 239, 240) GROUP BY V.CODIGOGA, V.CODIGOTPFROTA) A GROUP BY A.CODIGOGA ) KI ON KH.CODIGOGA = KI.CODIGOGA
            WHERE KH.DATA_BASE IS NOT NULL
            GROUP BY KH.CODIGOGA, TRUNC(KH.DATA_BASE, 'mm') -- Agrupa por Garagem e MÊS
            ORDER BY KH.CODIGOGA, TRUNC(KH.DATA_BASE, 'mm')
            `;