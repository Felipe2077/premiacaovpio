esse foi o script fornecido pelo powerBI



SELECT

    B.SETOR,

    B.OCORRENCIA,

    B.DATA,

    CASE

        WHEN NVL(SUM(B.KM_OPER), 0) = 0 THEN 0 

        ELSE ROUND((((SUM(B.KM_HOD2) - SUM(B.KM_OPER)) / SUM(B.KM_OPER)) * 100), 2)

    END AS DIF_KM_PORC

FROM

    (

        SELECT

            A.CODIGOGA,

            'KM OCIOSA' AS OCORRENCIA,

            CASE

                WHEN A.CODIGOGA = 31 THEN 'PARANOÁ'

                WHEN A.CODIGOGA = 124 THEN 'SANTA MARIA'

                WHEN A.CODIGOGA = 239 THEN 'SÃO SEBASTIÃO'

                WHEN A.CODIGOGA = 240 THEN 'GAMA'

                ELSE 'OUTRAS'

            END AS SETOR,

            TO_DATE('01/04/2025', 'DD/MM/YYYY') AS DATA,

            A.KM_HOD2,

            A.KM_OPER

        FROM

            (

                SELECT

                    BS.CODIGOGA,

                    BC.QTDVEIC,

                    BS.QTDVEICFRT,

                    NVL(BC.KM_OPER, 0) AS KM_OPER,

                    NVL(BC.KM_OCIOSA, 0) AS KM_OCIOSA,

                    (NVL(BC.KM_OPER, 0) * 0.05) AS KM_OCIOSA_5,

                    (NVL(BC.KM_OPER, 0) + NVL(BC.KM_OCIOSA, 0)) AS KM_OP_TOTAL,

                    NVL(HO.KM_HOD, 0) AS KM_HOD,

                    (NVL(ES.KM_ESP, 0) + NVL(KI.KMTOTALINT, 0)) AS KM_ESP, 

                    CASE

                        WHEN BS.CODIGOGA = 239 THEN 

                             ( NVL(HO.KM_HOD, 0) - (NVL(ES.KM_ESP, 0) + NVL(KI.KMTOTALINT, 0)) ) - 0

                        WHEN BS.CODIGOGA = 31  THEN

                             ( NVL(HO.KM_HOD, 0) - (NVL(ES.KM_ESP, 0) + NVL(KI.KMTOTALINT, 0)) ) - 0

                        ELSE

                             ( NVL(HO.KM_HOD, 0) - (NVL(ES.KM_ESP, 0) + NVL(KI.KMTOTALINT, 0)) )

                    END AS KM_HOD2 



                FROM

                    (

                        SELECT

                            COUNT(V.PREFIXOVEIC) AS QTDVEICFRT,

                            V.CODIGOGA

                        FROM

                            FRT_CADVEICULOS V,

                            FRT_TIPODEFROTA F

                        WHERE

                            V.CODIGOEMPRESA = 4

                            AND LENGTH(TO_NUMBER(V.PREFIXOVEIC)) > 5

                            AND V.CONDICAOVEIC = 'A'

                            AND V.CODIGOGA NOT IN (4)

                            AND V.CODIGOTPFROTA = F.CODIGOTPFROTA

                        GROUP BY

                            V.CODIGOGA

                    ) BS

                LEFT JOIN

                    ( 

                        SELECT

                             A.KM_OPER,

                             A.KM_OCIOSA,

                             A.QTDVEIC,

                             A.CODIGOGA

                        FROM

                            (

                                SELECT

                                    SUM(NVL(GLOBUS.FC_ARR_KMBCO(A.IDBCO, 0), 0)) KM_OPER,

                                    SUM(NVL(GLOBUS.FC_ARR_KMBCO(A.IDBCO, 1), 0)) KM_OCIOSA,

                                    COUNT(DISTINCT V.PREFIXOVEIC) AS QTDVEIC,

                                    V.CODIGOGA

                                FROM

                                    T_ARR_BCO A,

                                    T_ARR_BCO_VIAGENS B,

                                    FRT_CADVEICULOS V,

                                    FRT_TIPODEFROTA F

                                WHERE

                                    A.IDBCO = B.IDBCO

                                    AND A.DATABCO >= TO_DATE('01/04/2025', 'DD/MM/YYYY')

                                    AND A.DATABCO < TO_DATE('01/05/2025', 'DD/MM/YYYY')

                                    AND B.IDBCOVIAGENS = 1

                                    AND A.CODIGOEMPRESA = 4

                                    AND B.CODIGOVEIC = V.CODIGOVEIC

                                    AND V.CODIGOEMPRESA = 4

                                    AND V.CODIGOTPFROTA = F.CODIGOTPFROTA

                                    AND V.CODIGOGA IN (31, 124, 239, 240)

                                    AND V.CONDICAOVEIC = 'A'

                                GROUP BY

                                    V.CODIGOGA

                            ) A

                    ) BC ON BS.CODIGOGA = BC.CODIGOGA

                LEFT JOIN

                    (

                        SELECT

                            SUM(A.KMPERCORRIDOVELOC) AS KM_HOD,

                            A.CODIGOGA

                        FROM

                            (

                                SELECT

                                    C.KMPERCORRIDOVELOC,

                                    V.CODIGOGA,

                                    TO_DATE(TO_CHAR(C.DATAVELOC, 'DD/MM/YYYY') || ' ' || C.HORAVELOC, 'DD/MM/YYYY HH24:MI') AS DATATIME,

                                    C.HORAVELOC,

                                    C.DATAVELOC

                                FROM

                                    VWABA_CONFKMCARRO C,

                                    FRT_CADVEICULOS V,

                                    FRT_TIPODEFROTA F

                                WHERE

                                    C.DATAVELOC >= TO_DATE('01/04/2025', 'DD/MM/YYYY')

                                    AND C.DATAVELOC < TO_DATE('01/05/2025', 'DD/MM/YYYY')

                                    AND V.CODIGOVEIC = C.CODIGOVEIC

                                    AND V.CODIGOEMPRESA = 4

                                    AND V.CODIGOTPFROTA = F.CODIGOTPFROTA

                                    AND V.CODIGOGA IN (31, 124, 239, 240)

                                    AND V.CONDICAOVEIC = 'A'

                            ) A

                        WHERE

                            A.DATATIME >= TO_DATE('01/04/2025 04:00', 'DD/MM/YYYY HH24:MI')

                            AND A.DATATIME < TO_DATE('01/05/2025', 'DD/MM/YYYY')

                        GROUP BY

                            A.CODIGOGA

                    ) HO ON BS.CODIGOGA = HO.CODIGOGA

                LEFT JOIN

                    (

                        SELECT

                            SUM(A.KM_RODADO) AS KM_ESP,

                            A.CODIGOGA

                        FROM

                            (

                                SELECT

                                    (M.ODOMETROFIN - M.ODOMETROINIC) AS KM_RODADO,

                                    V.CODIGOGA

                                FROM

                                    PLT_SAIDARECOLHIDA M,

                                    PLT_OCORRENCIAS O,

                                    FRT_CADVEICULOS V,

                                    FRT_TIPODEFROTA F

                                WHERE

                                    M.CODIGOVEIC = V.CODIGOVEIC

                                    AND M.CODOCORRPLTSAIDA = O.CODOCORRPLT

                                    AND M.DTSAIDA >= TO_DATE('01/04/2025', 'DD/MM/YYYY')

                                    AND M.DTSAIDA < TO_DATE('01/05/2025', 'DD/MM/YYYY')

                                    AND M.CODOCORRPLTSAIDA BETWEEN 17 AND 26

                                    AND V.CODIGOTPFROTA = F.CODIGOTPFROTA

                                    AND V.CODIGOEMPRESA = 4

                                    AND V.CONDICAOVEIC = 'A'

                                    AND V.CODIGOGA IN (31, 124, 239, 240)

                            ) A

                        GROUP BY

                            A.CODIGOGA

                    ) ES ON BS.CODIGOGA = ES.CODIGOGA

                LEFT JOIN

                    (

                       SELECT A.CODIGOGA,

                               SUM(A.QTDVEICFRT * A.KM_INT) AS KMTOTALINT

                        FROM

                        (

                            SELECT COUNT(V.PREFIXOVEIC) AS QTDVEICFRT,

                                   V.CODIGOGA,

                                   V.CODIGOTPFROTA,

                                   F.DESCRICAOTPFROTA,

                                   CASE

                                       WHEN V.CODIGOGA IN (31, 239) THEN 0.60

                                       WHEN V.CODIGOTPFROTA IN (11, 9) AND V.CODIGOGA = 240 THEN 0.21

                                       WHEN V.CODIGOTPFROTA IN (3, 12) AND V.CODIGOGA = 240 THEN 0.60

                                       WHEN V.CODIGOTPFROTA = 9 AND V.CODIGOGA = 124 THEN 0.60

                                       WHEN V.CODIGOTPFROTA NOT IN (9) AND V.CODIGOGA = 124 THEN 0.80

                                       ELSE 0

                                   END AS KM_INT

                            FROM FRT_CADVEICULOS V,

                                 FRT_TIPODEFROTA F

                            WHERE V.CODIGOEMPRESA = 4

                              AND LENGTH(TO_NUMBER(V.PREFIXOVEIC)) > 5

                              AND V.CONDICAOVEIC = 'A'

                              AND V.CODIGOGA NOT IN (4)

                              AND V.CODIGOTPFROTA = F.CODIGOTPFROTA

                            GROUP BY V.CODIGOGA,

                                     V.CODIGOTPFROTA,

                                     F.DESCRICAOTPFROTA

                        ) A

                        GROUP BY A.CODIGOGA

                    ) KI ON BS.CODIGOGA = KI.CODIGOGA

            ) A

    ) B

GROUP BY

    B.CODIGOGA,

    B.OCORRENCIA,

    B.SETOR,

    B.DATA

ORDER BY B.SETOR