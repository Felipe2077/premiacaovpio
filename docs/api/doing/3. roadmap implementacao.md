# üó∫Ô∏è **ROADMAP PR√ÅTICO - IMPLEMENTA√á√ÉO METAS OPERACIONAIS**

**Baseado na Documenta√ß√£o T√©cnica Corrigida v2.0**  
**Objetivo:** Automatizar c√°lculo de metas para COMBUST√çVEL, PNEUS e PE√áAS

---

## **üìã VIS√ÉO GERAL DO PROJETO**

### **Entreg√°veis Finais:**

- 3 crit√©rios com metas calculadas automaticamente
- Interface integrada ao sistema existente
- Sistema de classifica√ß√£o de feriados
- Configura√ß√£o de par√¢metros espec√≠ficos
- Auditoria completa dos c√°lculos

### **Infraestrutura Aproveitada:**

- `OracleEtlService` existente
- `ParameterValueEntity` existente
- `PerformanceDataEntity` existente
- `CompetitionPeriodEntity` existente
- Sistema de autentica√ß√£o/autoriza√ß√£o existente

---

## **üöÄ SPRINT 1: FUNDA√á√ÉO E ESTRUTURAS BASE**

**Dura√ß√£o:** 2 semanas  
**Objetivo:** Criar estrutura de dados e integra√ß√£o Oracle

### **üìÅ Arquivos a Criar:**

#### **Entidades (3 novas)**

- `apps/api/src/entity/holiday-classification.entity.ts`
  - Armazenar classifica√ß√µes de feriados por per√≠odo
  - Relacionamento com CompetitionPeriodEntity
- `apps/api/src/entity/operational-goals-parameters.entity.ts`
  - Par√¢metros configur√°veis globais (fatores, percentuais)
  - Separado das metas espec√≠ficas
- `apps/api/src/entity/operational-goals-calculation.entity.ts`
  - Resultados tempor√°rios de c√°lculos (antes da aprova√ß√£o)
  - JSONB para flexibilidade dos dados

#### **Migra√ß√µes**

- `apps/api/src/database/migrations/001-create-holiday-classification.ts`
- `apps/api/src/database/migrations/002-create-operational-goals-parameters.ts`
- `apps/api/src/database/migrations/003-create-operational-goals-calculation.ts`
- `apps/api/src/database/migrations/004-seed-operational-parameters.ts`

#### **Servi√ßos Novos**

- `apps/api/src/modules/operational-goals/holiday-management.service.ts`
  - Detectar feriados via Brasil API
  - Gerenciar classifica√ß√µes
  - Validar completude
- `apps/api/src/modules/operational-goals/parameters.service.ts`
  - CRUD dos par√¢metros configur√°veis
  - Valida√ß√µes de faixa de valores
  - Auditoria de altera√ß√µes
- `apps/api/src/modules/operational-goals/oracle-data.service.ts`
  - Estender OracleEtlService existente
  - Queries espec√≠ficas para KM e combust√≠vel
  - Mapeamento de garagens por nome
- `apps/api/src/modules/operational-goals/sector-mapping.service.ts`
  - Mapeamento Oracle CODIGOGA ‚Üí SectorEntity por nome
  - Aproveitamento do mapeamento j√° existente no ETL

#### **Utilit√°rios**

- `apps/api/src/utils/brasil-api.client.ts`
  - Cliente para API de feriados brasileiros
  - Cache e tratamento de erros
- `apps/api/src/utils/date-calculator.ts`
  - C√°lculos de calend√°rio mensal
  - Contagem de dias √∫teis/s√°bados/domingos

### **üîß Arquivos a Modificar:**

#### **Data Source**

- `apps/api/src/database/data-source.ts`
  - Adicionar 3 novas entidades no array de entities

#### **Shared Types (se necess√°rio)**

- `packages/shared-types/src/operational-goals.types.ts`
  - Tipos para classifica√ß√£o de feriados
  - Interfaces de par√¢metros
  - DTOs b√°sicos

### **üìã Depend√™ncias:**

- ‚úÖ API j√° configurada com Oracle
- ‚úÖ Sistema de migra√ß√£o funcionando
- ‚úÖ Brasil API acess√≠vel

### **‚úÖ Crit√©rios de Aceite:**

- [ ] 3 novas entidades criadas e migradas
- [ ] Feriados sendo detectados automaticamente
- [ ] Par√¢metros padr√£o inseridos no banco
- [ ] Mapeamento de setores funcionando
- [ ] Query Oracle b√°sica retornando dados
- [ ] Testes unit√°rios dos novos servi√ßos

---

## **üßÆ SPRINT 2: ALGORITMOS DE C√ÅLCULO**

**Dura√ß√£o:** 2 semanas  
**Objetivo:** Implementar l√≥gica de c√°lculo das 3 metas

### **üìÅ Arquivos a Criar:**

#### **Servi√ßo Principal**

- `apps/api/src/modules/operational-goals/calculation.service.ts`
  - Motor principal de c√°lculo
  - Orquestra√ß√£o dos 4 algoritmos (KM ‚Üí Combust√≠vel ‚Üí Pneus ‚Üí Pe√ßas)
  - Valida√ß√µes de pr√©-requisitos

#### **Algoritmos Espec√≠ficos**

- `apps/api/src/modules/operational-goals/algorithms/km-prevista.algorithm.ts`
  - An√°lise de padr√µes hist√≥ricos
  - Classifica√ß√£o de feriados
  - Proje√ß√£o para m√™s futuro
- `apps/api/src/modules/operational-goals/algorithms/combustivel.algorithm.ts`
  - Efici√™ncia m√©dia dos √∫ltimos 3 meses
  - Aplica√ß√£o do fator de redu√ß√£o
  - Uso de RawOracleFleetPerformanceEntity
- `apps/api/src/modules/operational-goals/algorithms/pneus-pecas.algorithm.ts`
  - C√°lculo de custo m√©dio anual (12 meses)
  - Sistema de saldo devedor
  - Uso de PerformanceDataEntity existente
- `apps/api/src/modules/operational-goals/algorithms/saldo.algorithm.ts`
  - C√°lculo de saldo devedor
  - Busca em ParameterValueEntity (metas anteriores)
  - Busca em PerformanceDataEntity (gastos reais)

#### **Validadores**

- `apps/api/src/modules/operational-goals/validators/pre-calculation.validator.ts`
  - Per√≠odo em status PLANEJAMENTO
  - Feriados classificados
  - Dados hist√≥ricos dispon√≠veis
- `apps/api/src/modules/operational-goals/validators/business-rules.validator.ts`
  - Valida√ß√µes de valores calculados
  - Faixas aceit√°veis de resultados
  - Detec√ß√£o de anomalias

#### **Tipos e Interfaces**

- `apps/api/src/modules/operational-goals/types/calculation.types.ts`
  - Interfaces de input/output dos algoritmos
  - Tipos de resultados por crit√©rio
  - Estruturas de dados intermedi√°rios

### **üîß Arquivos a Modificar:**

#### **Servi√ßos Existentes**

- `apps/api/src/modules/parameters/parameter.service.ts`
  - Adicionar m√©todo `saveOperationalGoalsMetas()`
  - Integra√ß√£o com sistema de metas existente
- `apps/api/src/modules/periods/period.service.ts`
  - Adicionar hook `onPeriodCreated()`
  - Atualizar valida√ß√£o `canActivatePeriod()`

### **üìã Depend√™ncias:**

- ‚úÖ Sprint 1 completa (entidades e servi√ßos base)
- ‚úÖ Dados hist√≥ricos na base de dados
- ‚úÖ Par√¢metros configurados

### **‚úÖ Crit√©rios de Aceite:**

- [ ] Algoritmo KM Prevista calculando corretamente
- [ ] Algoritmo Combust√≠vel usando dados reais
- [ ] Algoritmo Pneus/Pe√ßas com sistema de saldo
- [ ] Valida√ß√µes impedindo c√°lculos inv√°lidos
- [ ] Resultados conferindo com planilha Excel
- [ ] Testes com dados reais da aplica√ß√£o

---

## **üåê SPRINT 3: APIs REST E INTEGRA√á√ÉO**

**Dura√ß√£o:** 1 semana  
**Objetivo:** Criar endpoints e integrar com sistema de servi√ßos

### **üìÅ Arquivos a Criar:**

#### **Rotas**

- `apps/api/src/routes/operational-goals.routes.ts`
  - Todas as rotas espec√≠ficas da funcionalidade
  - Middleware de autentica√ß√£o/autoriza√ß√£o
  - Valida√ß√£o de entrada com Zod

#### **Controllers/Handlers**

- `apps/api/src/modules/operational-goals/handlers/holidays.handler.ts`
  - GET /periods/:id/holidays-status
  - POST /periods/:id/classify-holidays
- `apps/api/src/modules/operational-goals/handlers/calculation.handler.ts`
  - POST /periods/:id/calculate
  - GET /calculations/:id
  - POST /calculations/:id/approve
- `apps/api/src/modules/operational-goals/handlers/parameters.handler.ts`
  - GET /parameters
  - PUT /parameters/:name

#### **DTOs e Valida√ß√£o**

- `apps/api/src/modules/operational-goals/dto/classify-holidays.dto.ts`
- `apps/api/src/modules/operational-goals/dto/calculate-goals.dto.ts`
- `apps/api/src/modules/operational-goals/dto/approve-calculation.dto.ts`
- `apps/api/src/modules/operational-goals/dto/update-parameter.dto.ts`

#### **Middleware Espec√≠fico**

- `apps/api/src/middleware/operational-goals.middleware.ts`
  - Valida√ß√£o de per√≠odo em PLANEJAMENTO
  - Verifica√ß√£o de feriados classificados
  - Rate limiting para c√°lculos

### **üîß Arquivos a Modificar:**

#### **Sistema de Servi√ßos**

- `apps/api/src/plugins/services.ts`
  - Adicionar novos servi√ßos ao container DI
  - Manter servi√ßos existentes

#### **Registro de Rotas**

- `apps/api/src/server.ts`
  - Registrar operational-goals.routes.ts
  - Manter ordem correta de middleware

#### **Shared Types (DTOs)**

- `packages/shared-types/src/operational-goals.dto.ts`
  - DTOs para comunica√ß√£o com frontend
  - Interfaces de resposta das APIs

### **üìã Depend√™ncias:**

- ‚úÖ Sprint 2 completa (algoritmos funcionando)
- ‚úÖ Sistema de autentica√ß√£o configurado
- ‚úÖ Middleware RBAC funcionando

### **‚úÖ Crit√©rios de Aceite:**

- [ ] Todas as rotas funcionando via Postman
- [ ] Autentica√ß√£o/autoriza√ß√£o validada
- [ ] Metas sendo salvas em ParameterValueEntity
- [ ] Per√≠odo pode ser ativado ap√≥s aprova√ß√£o
- [ ] Documenta√ß√£o Swagger atualizada
- [ ] Tratamento de erros padronizado

---

## **üé® SPRINT 4: INTERFACE GERENCIAL**

**Dura√ß√£o:** 1 semana  
**Objetivo:** Interface integrada ao sistema existente

### **üìÅ Arquivos a Criar:**

#### **Componentes Principais**

- `apps/web/src/components/operational-goals/HolidayClassificationSection.tsx`
  - Interface para classificar feriados
  - Integrado √† tela de gest√£o de per√≠odos
- `apps/web/src/components/operational-goals/CalculationSection.tsx`
  - Execu√ß√£o do c√°lculo
  - Visualiza√ß√£o de resultados
  - Aprova√ß√£o de metas
- `apps/web/src/components/operational-goals/CalculationResults.tsx`
  - Exibi√ß√£o detalhada dos resultados
  - Compara√ß√£o com metas anteriores
  - Bot√µes de a√ß√£o (aprovar/recalcular)

#### **Tela de Configura√ß√£o**

- `apps/web/src/app/configuracao/parametros-operacionais/page.tsx`
  - P√°gina para configurar par√¢metros
  - Apenas para diretores
- `apps/web/src/components/operational-goals/ParametersConfig.tsx`
  - Formul√°rio de edi√ß√£o de par√¢metros
  - Valida√ß√µes e justificativas
  - Hist√≥rico de altera√ß√µes

#### **Componentes Auxiliares**

- `apps/web/src/components/operational-goals/HolidayClassificationCard.tsx`
  - Card individual para cada feriado
  - Radio buttons para classifica√ß√£o
- `apps/web/src/components/operational-goals/CalculationProgressIndicator.tsx`
  - Indicador de progresso do c√°lculo
  - Estados de loading
- `apps/web/src/components/operational-goals/ParameterEditCard.tsx`
  - Card para editar par√¢metro espec√≠fico
  - Valida√ß√£o inline

#### **Hooks Customizados**

- `apps/web/src/hooks/useHolidayManagement.ts`
  - Gerenciamento de estado dos feriados
  - Chamadas para API
- `apps/web/src/hooks/useOperationalGoalsCalculation.ts`
  - Execu√ß√£o e acompanhamento de c√°lculos
  - Cache de resultados
- `apps/web/src/hooks/useOperationalParameters.ts`
  - CRUD dos par√¢metros
  - Valida√ß√µes

### **üîß Arquivos a Modificar:**

#### **Tela de Gest√£o de Per√≠odos**

- `apps/web/src/app/gestao/periodos/[id]/page.tsx`
  - Integrar se√ß√µes de classifica√ß√£o e c√°lculo
  - Manter funcionalidades existentes
- `apps/web/src/components/periods/PeriodManagement.tsx`
  - Adicionar HolidayClassificationSection
  - Adicionar CalculationSection
  - Condicionais baseadas no status

#### **Se√ß√£o de Outras Metas**

- `apps/web/src/components/periods/OtherGoalsSection.tsx`
  - Excluir COMBUST√çVEL, PNEUS, PE√áAS da lista
  - Mostrar que s√£o calculados automaticamente

#### **Navega√ß√£o**

- `apps/web/src/components/layout/Navigation.tsx`
  - Adicionar link para configura√ß√£o de par√¢metros
  - Restrito a diretores

### **üìã Depend√™ncias:**

- ‚úÖ Sprint 3 completa (APIs funcionando)
- ‚úÖ Sistema de autentica√ß√£o no frontend
- ‚úÖ Componentes base da aplica√ß√£o

### **‚úÖ Crit√©rios de Aceite:**

- [ ] Fluxo completo funcionando na interface
- [ ] Classifica√ß√£o de feriados intuitiva
- [ ] Resultados de c√°lculo claros
- [ ] Configura√ß√£o de par√¢metros funcional
- [ ] Design consistente com aplica√ß√£o
- [ ] Responsivo em mobile

---

## **üöÄ SPRINT 5: HOMOLOGA√á√ÉO E DEPLOY**

**Dura√ß√£o:** 1 semana  
**Objetivo:** Valida√ß√£o e deploy em produ√ß√£o

### **üìÅ Arquivos a Criar:**

#### **Documenta√ß√£o**

- `docs/operational-goals/user-manual.md`
  - Manual para diretores
  - Passo a passo de uso
- `docs/operational-goals/troubleshooting.md`
  - Problemas comuns e solu√ß√µes
  - Procedimentos de recovery
- `docs/operational-goals/api-documentation.md`
  - Documenta√ß√£o t√©cnica das APIs
  - Exemplos de uso

#### **Scripts de Deploy**

- `scripts/deploy-operational-goals.sh`
  - Deploy automatizado
  - Valida√ß√µes pr√©-deploy
- `scripts/rollback-operational-goals.sh`
  - Rollback em caso de problemas
  - Restore de dados

#### **Testes E2E**

- `apps/web/cypress/e2e/operational-goals.cy.ts`
  - Teste completo do fluxo
  - Simula√ß√£o de usu√°rio real
- `apps/api/tests/e2e/operational-goals.test.ts`
  - Testes de integra√ß√£o completos
  - Cen√°rios de erro

#### **Seeds para Homologa√ß√£o**

- `apps/api/src/database/seeds/operational-goals-demo.ts`
  - Dados realistas para teste
  - Per√≠odos de exemplo

### **üîß Arquivos a Modificar:**

#### **Configura√ß√£o de Deploy**

- `apps/api/package.json`
  - Scripts de migra√ß√£o em produ√ß√£o
- `docker-compose.prod.yml`
  - Configura√ß√µes espec√≠ficas se necess√°rio

### **üìã Depend√™ncias:**

- ‚úÖ Sprint 4 completa (interface funcionando)
- ‚úÖ Ambiente de homologa√ß√£o configurado
- ‚úÖ Dados hist√≥ricos em homologa√ß√£o

### **‚úÖ Crit√©rios de Aceite:**

- [ ] Todos os testes E2E passando
- [ ] Valida√ß√£o com planilha Excel real
- [ ] Performance adequada (c√°lculo < 2min)
- [ ] Deploy de produ√ß√£o sem erros
- [ ] Primeiro per√≠odo real calculado
- [ ] Usu√°rios treinados e satisfeitos
- [ ] Documenta√ß√£o completa

---

## **üìä RESUMO EXECUTIVO**

### **üìà Estat√≠sticas do Projeto:**

- **5 sprints** √ó **7 semanas** total
- **3 entidades novas** (m√≠nimo necess√°rio)
- **12 arquivos principais** a criar
- **8 arquivos existentes** a modificar
- **4 algoritmos espec√≠ficos** a implementar
- **8 endpoints REST** novos

### **üéØ Marcos Principais:**

1. **Semana 2:** Base de dados e ETL funcionando
2. **Semana 4:** Algoritmos calculando corretamente
3. **Semana 5:** APIs REST completas
4. **Semana 6:** Interface integrada
5. **Semana 7:** Deploy e primeiro uso real

### **‚ö†Ô∏è Riscos Identificados:**

- **Query Oracle:** Validar sintaxe no ambiente real
- **Mapeamento:** Confirmar nomes exatos das garagens
- **Performance:** Monitorar tempo de c√°lculo
- **Integra√ß√£o:** Testar impacto no sistema existente

### **‚úÖ Fatores de Sucesso:**

- **Aproveitamento m√°ximo** da infraestrutura existente
- **Desenvolvimento incremental** com valida√ß√µes
- **Integra√ß√£o natural** com workflow atual
- **Testes cont√≠nuos** com dados reais

---

**üéØ Este roadmap garante uma implementa√ß√£o segura, incremental e que aproveita ao m√°ximo a arquitetura robusta j√° existente na API.**
